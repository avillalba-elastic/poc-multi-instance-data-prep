{
  "Comment": "Process sharded by key",
  "StartAt": "SetVariables",
  "QueryLanguage": "JSONata",
  "States": {
    "SetVariables": {
      "Type": "Pass",
      "Next": "processShards",
      "Assign": {
        "common_tags": [
            {
            "Key": "division",
            "Value": "engineering"
            },
            {
            "Key": "team",
            "Value": "ml"
            },
            {
            "Key": "team-group",
            "Value": "ml-rd"
            },
            {
            "Key": "org",
            "Value": "elasticsearch"
            }
        ]
      }
    },
    "processShards": {
      "Resource": "arn:aws:states:::sagemaker:createProcessingJob.sync",
      "Arguments": {
        "ProcessingResources": {
          "ClusterConfig": {
            "InstanceCount": 10,
            "InstanceType": "ml.m5.xlarge",
            "VolumeSizeInGB": 24
          }
        },
        "AppSpecification": {
          "ImageUri": "879381254630.dkr.ecr.us-east-1.amazonaws.com/poc-multi-instance-data-prep/standard-image:latest",
          "ContainerEntrypoint": [
            "seq_process"
          ]
        },
        "ProcessingInputs": [
          {
            "InputName": "input_data_shards",
            "S3Input": {
              "S3DataType": "S3Prefix",
              "S3Uri": "s3://mvp-mlops-platform/poc-multi-instance-data-prep/",
              "LocalPath": "/opt/ml/processing/input",
              "S3DataDistributionType": "ShardedByS3Key",
              "S3InputMode": "File"
            }
          }
        ],
        "ProcessingOutputConfig": {
          "Outputs": [
            {
              "OutputName": "output_data_shards",
              "S3Output": {
                "S3UploadMode": "EndOfJob",
                "S3Uri": "s3://mvp-mlops-platform/poc-multi-instance-data-prep-seq_sharding_outputs/",
                "LocalPath": "/opt/ml/processing/output"
              }
            }
          ]
        },
        "RoleArn": "arn:aws:iam::879381254630:role/service-role/AmazonSageMaker-ExecutionRole-20241203T102031",
        "Tags": "{% $common_tags %}",
        "ProcessingJobName": "{% $uuid() %}"
      },
      "Type": "Task",
      "End": true
    }
  }
}
